<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Custom Vision API Demo</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body {
            padding: 50px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="mt-5 mb-4">Custom Vision Decoration</h1>
    
    <form id="customVisionForm">
        <div class="form-group">
            <label for="inputType">Select Input Type:</label>
            <select class="form-control" id="inputType" onchange="toggleInputField()">
                <option value="link">Link</option>
                <option value="image">Image</option>
            </select>
        </div>
        
        <div class="form-group" id="linkInput">
            <label for="link">Enter Link:</label>
            <input type="text" class="form-control" id="link" placeholder="Enter URL">
        </div>

        <!-- Ajoutez cette partie dans votre formulaire -->
        <div class="form-group" id="fileInput">
            <label for="imageFile">Upload Image:</label>
            <input type="file" class="form-control-file" id="imageFile" accept="image/*">
        </div>

        <button type="button" class="btn btn-primary" onclick="submitForm()">Submit</button>
    </form>

    <div id="result" class="mt-4" style="display: none;">
        <h2>Predictions</h2>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Tag</th>
                    <th scope="col">Probability</th>
                </tr>
            </thead>
            <tbody id="predictionsTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Bootstrap JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    const functionEndpoint = 'https://testfunc0198.azurewebsites.net/api/decoration?url='; // Remplacez ceci par l'URL de votre fonction Azure

    function toggleInputField() {
        var inputType = document.getElementById('inputType').value;
        document.getElementById('linkInput').style.display = (inputType === 'link') ? 'block' : 'none';
        document.getElementById('fileInput').style.display = (inputType === 'image') ? 'block' : 'none';
    }

    async function submitForm() {
        var inputType = document.getElementById('inputType').value;
        var input;

        if (inputType === 'link') {
            var url = document.getElementById('link').value;
            // Validate URL
            if (!isValidImageUrl(url)) {
                alert('Please enter a valid URL.');
                return;
            }

            input = { 'url': url };
        } else if (inputType === 'image') {
            var fileInput = document.getElementById('imageFile');
            var file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image file.');
                return;
            }

            // Upload the image to Blob Storage
            var imageUrl = await uploadImageToBlobStorage(file);
            input = { 'url': imageUrl };
        }

        try {
            const functionUrl = ${functionEndpoint}?url=${encodeURIComponent(input.url)};
            const apiKey = 'rania123++'; // Replace with your actual Azure Function key

            const response = await fetch(functionUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'x-functions-key': apiKey
                }
            });

            if (response.ok) {
                const result = await response.json();
                displayResult(result);
            } else {
                throw new Error('Error: ' + response.status + ', ' + await response.text());
            }
        } catch (error) {
            console.error(error);
        }
    }

    function displayResult(result) {
        var predictionsTableBody = document.getElementById('predictionsTableBody');
        predictionsTableBody.innerHTML = '';

        for (var i = 0; i < result.predictions.length; i++) {
            var prediction = result.predictions[i];
            var row = predictionsTableBody.insertRow(i);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);

            cell1.innerHTML = prediction.tagName;
            cell2.innerHTML = (prediction.probability * 100).toFixed(2) + '%';
        }

        document.getElementById('result').style.display = 'block';
    }

    function isValidImageUrl(url) {
        return /^https?:\/\/\S+\.(?:png|jpg|jpeg|bmp)$/i.test(url);
    }

    async function uploadImageToBlobStorage(file) {
        var storageAccountName = 'decofrontstockage';
        var containerName = 'docofrontconteneur';

        var blobService = AzureStorage.Blob.createBlobService(storageAccountName);
        var blobName = 'image_' + Date.now() + '_' + file.name;

        return new Promise((resolve, reject) => {
            blobService.createBlockBlobFromBrowserFile(containerName, blobName, file, {}, (error, result, response) => {
                if (!error) {
                    var imageUrl = blobService.getUrl(containerName, blobName);
                    resolve(imageUrl);
                } else {
                    reject(error);
                }
            });
        });
    }
</script>
</body>
</html>
